---
title: "Env_data"
author: "Stefano Larsen"
date: "5/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 6)
```

```{r}
library(readxl)
library(tidyverse)
library(reshape2)
library(ggrepel)
library(zoo)
```

# Import the chemistry data for each stream
##LI.chem
```{r}
LI1.chem=read_excel("LB_chemistry_clean_reduce.xlsx", 
    sheet = "LI1")

LI1.chem$Date=as.Date(LI1.chem$Date, format="%Y-%m-%d")

LI1.chem$month=months(LI1.chem$Date)
LI1.chem$year=format(LI1.chem$Date, '%Y')
#add season
LI1.chem$Season=NA
LI1.chem$Season[which(LI1.chem$month %in% c('October', 'November', 'December', 'January', 'February', 'March'))]='Winter'
LI1.chem$Season[which(LI1.chem$month %in% c('April', 'May', 'June', 'July', 'August', 'September'))]='Summer'

```

##LI2
```{r}
LI2.chem=read_excel("LB_chemistry_clean_reduce.xlsx", 
    sheet = "LI2", col_types = c("text", 
        "date", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))

LI2.chem$month=months(LI2.chem$Date)
LI2.chem$year=format(LI2.chem$Date, '%Y')
#add season
LI2.chem$Season=NA
LI2.chem$Season[which(LI2.chem$month %in% c('October', 'November', 'December', 'January', 'February', 'March'))]='Winter'
LI2.chem$Season[which(LI2.chem$month %in% c('April', 'May', 'June', 'July', 'August', 'September'))]='Summer'
```

##LI3
```{r}
LI3.chem=read_excel("LB_chemistry_clean_reduce.xlsx", 
    sheet = "LI3", col_types = c("text", 
        "date", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))

LI3.chem$month=months(LI3.chem$Date)
LI3.chem$year=format(LI3.chem$Date, '%Y')

#add season
LI3.chem$Season=NA
LI3.chem$Season[which(LI3.chem$month %in% c('October', 'November', 'December', 'January', 'February', 'March'))]='Winter'
LI3.chem$Season[which(LI3.chem$month %in% c('April', 'May', 'June', 'July', 'August', 'September'))]='Summer'

```

##LI4
```{r}
LI4.chem=read_excel("LB_chemistry_clean_reduce.xlsx", 
    sheet = "LI4", col_types = c("text", 
        "date", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))

LI4.chem$month=months(LI4.chem$Date)
LI4.chem$year=format(LI4.chem$Date, '%Y')

#add season
LI4.chem$Season=NA
LI4.chem$Season[which(LI4.chem$month %in% c('October', 'November', 'December', 'January', 'February', 'March'))]='Winter'
LI4.chem$Season[which(LI4.chem$month %in% c('April', 'May', 'June', 'July', 'August', 'September'))]='Summer'

```

##LI5
```{r}
LI5.chem=read_excel("LB_chemistry_clean_reduce.xlsx", 
    sheet = "LI5", col_types = c("text", 
        "date", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))

LI5.chem$month=months(LI5.chem$Date)
LI5.chem$year=format(LI5.chem$Date, '%Y')

#add season
LI5.chem$Season=NA
LI5.chem$Season[which(LI5.chem$month %in% c('October', 'November', 'December', 'January', 'February', 'March'))]='Winter'
LI5.chem$Season[which(LI5.chem$month %in% c('April', 'May', 'June', 'July', 'August', 'September'))]='Summer'
```


##LI6
```{r}
LI6.chem=read_excel("LB_chemistry_clean_reduce.xlsx", 
    sheet = "LI6", col_types = c("text", 
        "date", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))

LI6.chem$month=months(LI6.chem$Date)
LI6.chem$year=format(LI6.chem$Date, '%Y')

#add season
LI6.chem$Season=NA
LI6.chem$Season[which(LI6.chem$month %in% c('October', 'November', 'December', 'January', 'February', 'March'))]='Winter'
LI6.chem$Season[which(LI6.chem$month %in% c('April', 'May', 'June', 'July', 'August', 'September'))]='Summer'
```


##LI7
```{r}
LI7.chem=read_excel("LB_chemistry_clean_reduce.xlsx", 
    sheet = "LI7", col_types = c("text", 
        "date", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))

LI7.chem$month=months(LI7.chem$Date)
LI7.chem$year=format(LI7.chem$Date, '%Y')

#add season
LI7.chem$Season=NA
LI7.chem$Season[which(LI7.chem$month %in% c('October', 'November', 'December', 'January', 'February', 'March'))]='Winter'
LI7.chem$Season[which(LI7.chem$month %in% c('April', 'May', 'June', 'July', 'August', 'September'))]='Summer'
```


##LI8
```{r}
LI8.chem=read_excel("LB_chemistry_clean_reduce.xlsx", 
    sheet = "LI8", col_types = c("text", 
        "date", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))

LI8.chem$month=months(LI8.chem$Date)
LI8.chem$year=format(LI8.chem$Date, '%Y')

#add season
LI8.chem$Season=NA
LI8.chem$Season[which(LI8.chem$month %in% c('October', 'November', 'December', 'January', 'February', 'March'))]='Winter'
LI8.chem$Season[which(LI8.chem$month %in% c('April', 'May', 'June', 'July', 'August', 'September'))]='Summer'
```

##CI1
```{r}
CI1.chem=read_excel("LB_chemistry_clean_reduce.xlsx", 
    sheet = "CI1", col_types = c("text", 
        "date", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))

CI1.chem$month=months(CI1.chem$Date)
CI1.chem$year=format(CI1.chem$Date, '%Y')

#add season
CI1.chem$Season=NA
CI1.chem$Season[which(CI1.chem$month %in% c('October', 'November', 'December', 'January', 'February', 'March'))]='Winter'
CI1.chem$Season[which(CI1.chem$month %in% c('April', 'May', 'June', 'July', 'August', 'September'))]='Summer'
```

##CI2
```{r}
CI2.chem=read_excel("LB_chemistry_clean_reduce.xlsx", 
    sheet = "CI2", col_types = c("text", 
        "date", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))

CI2.chem$month=months(CI2.chem$Date)
CI2.chem$year=format(CI2.chem$Date, '%Y')

#add season
CI2.chem$Season=NA
CI2.chem$Season[which(CI2.chem$month %in% c('October', 'November', 'December', 'January', 'February', 'March'))]='Winter'
CI2.chem$Season[which(CI2.chem$month %in% c('April', 'May', 'June', 'July', 'August', 'September'))]='Summer'
```


##CI3
```{r}
CI3.chem=read_excel("LB_chemistry_clean_reduce.xlsx", 
    sheet = "CI3", col_types = c("text", 
        "date", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))

CI3.chem$month=months(CI3.chem$Date)
CI3.chem$year=format(CI3.chem$Date, '%Y')

#add season
CI3.chem$Season=NA
CI3.chem$Season[which(CI3.chem$month %in% c('October', 'November', 'December', 'January', 'February', 'March'))]='Winter'
CI3.chem$Season[which(CI3.chem$month %in% c('April', 'May', 'June', 'July', 'August', 'September'))]='Summer'
```

##CI4
```{r}
CI4.chem=read_excel("LB_chemistry_clean_reduce.xlsx", 
    sheet = "CI4", col_types = c("text", 
        "date", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))

CI4.chem$month=months(CI4.chem$Date)
CI4.chem$year=format(CI4.chem$Date, '%Y')

#add season
CI4.chem$Season=NA
CI4.chem$Season[which(CI4.chem$month %in% c('October', 'November', 'December', 'January', 'February', 'March'))]='Winter'
CI4.chem$Season[which(CI4.chem$month %in% c('April', 'May', 'June', 'July', 'August', 'September'))]='Summer'
```

##CI5
```{r}
CI5.chem=read_excel("LB_chemistry_clean_reduce.xlsx", 
    sheet = "CI5X", col_types = c("text", 
        "date", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))

CI5.chem$month=months(CI5.chem$Date)
CI5.chem$year=format(CI5.chem$Date, '%Y')

#add season
CI5.chem$Season=NA
CI5.chem$Season[which(CI5.chem$month %in% c('October', 'November', 'December', 'January', 'February', 'March'))]='Winter'
CI5.chem$Season[which(CI5.chem$month %in% c('April', 'May', 'June', 'July', 'August', 'September'))]='Summer'
```

##CI6
```{r}
CI6.chem=read_excel("LB_chemistry_clean_reduce.xlsx", 
    sheet = "CI6", col_types = c("text", 
        "date", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))

CI6.chem$month=months(CI6.chem$Date)
CI6.chem$year=format(CI6.chem$Date, '%Y')

#add season
CI6.chem$Season=NA
CI6.chem$Season[which(CI6.chem$month %in% c('October', 'November', 'December', 'January', 'February', 'March'))]='Winter'
CI6.chem$Season[which(CI6.chem$month %in% c('April', 'May', 'June', 'July', 'August', 'September'))]='Summer'
```



# Now check outlier

## crazy outliers in some parameters

```{r}
summary(LI1.chem)
```

# Function to covert max values into NA (remove max values from a vector)
```{r}
max2na=function(x){
  x[which.max(x)]=NA
  return(x)
}

#tests
test=c(1,2,3,4,5,10)
which.max(test)
test[which.max(test)]=NA
test=max2na(test)


which.max(LI1.chem$Mn_Filtered)
```

# transform chemistry dfs for each site, removing the max values for each variable.
```{r}
LI1.chem=cbind(
  LI1.chem[,c(1,2,16,17,18)],# re attach the charachter variables 
  apply(LI1.chem[,c(3:15)],2, max2na)# remove the max values
)
```


```{r}
LI2.chem=cbind(
  LI2.chem[,c(1,2,16,17,18)],# re attach the charachter variables 
  apply(LI2.chem[,c(3:15)],2, max2na)# remove the max values
)
```

```{r}
LI3.chem=cbind(
  LI3.chem[,c(1,2,16,17,18)],# re attach the charachter variables 
  apply(LI3.chem[,c(3:15)],2, max2na)# remove the max values
)
```

```{r}
LI4.chem=cbind(
  LI4.chem[,c(1,2,16,17,18)],# re attach the charachter variables 
  apply(LI4.chem[,c(3:15)],2, max2na)# remove the max values
)
```


```{r}
LI5.chem=cbind(
  LI5.chem[,c(1,2,16,17,18)],# re attach the charachter variables 
  apply(LI5.chem[,c(3:15)],2, max2na)# remove the max values
)
```


```{r}
LI6.chem=cbind(
  LI6.chem[,c(1,2,16,17,18)],# re attach the charachter variables 
  apply(LI6.chem[,c(3:15)],2, max2na)# remove the max values
)
```


```{r}
LI7.chem=cbind(
  LI7.chem[,c(1,2,16,17,18)],# re attach the charachter variables 
  apply(LI7.chem[,c(3:15)],2, max2na)# remove the max values
)
```

```{r}
LI8.chem=cbind(
  LI8.chem[,c(1,2,16,17,18)],# re attach the charachter variables 
  apply(LI8.chem[,c(3:15)],2, max2na)# remove the max values
)
```

```{r}
CI1.chem=cbind(
  CI1.chem[,c(1,2,16,17,18)],# re attach the charachter variables 
  apply(CI1.chem[,c(3:15)],2, max2na)# remove the max values
)
```

```{r}
CI2.chem=cbind(
  CI2.chem[,c(1,2,16,17,18)],# re attach the charachter variables 
  apply(CI2.chem[,c(3:15)],2, max2na)# remove the max values
)
```

```{r}
CI3.chem=cbind(
  CI3.chem[,c(1,2,16,17,18)],# re attach the charachter variables 
  apply(CI3.chem[,c(3:15)],2, max2na)# remove the max values
)
```

```{r}
CI4.chem=cbind(
  CI4.chem[,c(1,2,16,17,18)],# re attach the charachter variables 
  apply(CI4.chem[,c(3:15)],2, max2na)# remove the max values
)
```

```{r}
CI5.chem=cbind(
  CI5.chem[,c(1,2,16,17,18)],# re attach the charachter variables 
  apply(CI5.chem[,c(3:15)],2, max2na)# remove the max values
)
```

```{r}
CI6.chem=cbind(
  CI6.chem[,c(1,2,16,17,18)],# re attach the charachter variables 
  apply(CI6.chem[,c(3:15)],2, max2na)# remove the max values
)
```


```{r}
summary(LI4.chem)
```


# Visualize some boxplot for examination
```{r}
LI1.chem %>%
  select(-c(Site, Date, year, Season, month)) %>% 
  gather() %>% 
  ggplot()+aes(x=key, y=value)+geom_boxplot()+facet_wrap(~key, scale='free')
```







######################################
# tests to *assign winter year label* to months from following year of sampling
```{r}
LI1.chem$year=as.numeric(LI1.chem$year)
```

## *winter year* : months of oct, nov, dec are considered winter from the sampling occurring the following year (April).
Will use this winter year label to aggregate by year and season. 

```{r}
LI1.chem$winter.year <- ifelse(LI1.chem$month %in% c('January','February','March'), LI1.chem$year, ifelse(LI1.chem$month %in% c('October', 'November','December'), LI1.chem$year+1, LI1.chem$year))
```

```{r}
LI2.chem$year=as.numeric(LI2.chem$year)
LI2.chem$winter.year <- ifelse(LI2.chem$month %in% c('January','February','March'), LI2.chem$year, ifelse(LI2.chem$month %in% c('October', 'November','December'), LI2.chem$year+1, LI2.chem$year))
```

```{r}
LI3.chem$year=as.numeric(LI3.chem$year)
LI3.chem$winter.year <- ifelse(LI3.chem$month %in% c('January','February','March'), LI3.chem$year, ifelse(LI3.chem$month %in% c('October', 'November','December'), LI3.chem$year+1, LI3.chem$year))
```

```{r}
LI4.chem$year=as.numeric(LI4.chem$year)
LI4.chem$winter.year <- ifelse(LI4.chem$month %in% c('January','February','March'), LI4.chem$year, ifelse(LI4.chem$month %in% c('October', 'November','December'), LI4.chem$year+1, LI4.chem$year))
```

```{r}
LI5.chem$year=as.numeric(LI5.chem$year)
LI5.chem$winter.year <- ifelse(LI5.chem$month %in% c('January','February','March'), LI5.chem$year, ifelse(LI5.chem$month %in% c('October', 'November','December'), LI5.chem$year+1, LI5.chem$year))
```

```{r}
LI6.chem$year=as.numeric(LI6.chem$year)
LI6.chem$winter.year <- ifelse(LI6.chem$month %in% c('January','February','March'), LI6.chem$year, ifelse(LI6.chem$month %in% c('October', 'November','December'), LI6.chem$year+1, LI6.chem$year))
```

```{r}
LI7.chem$year=as.numeric(LI7.chem$year)
LI7.chem$winter.year <- ifelse(LI7.chem$month %in% c('January','February','March'), LI7.chem$year, ifelse(LI7.chem$month %in% c('October', 'November','December'), LI7.chem$year+1, LI7.chem$year))
```

```{r}
LI8.chem$year=as.numeric(LI8.chem$year)
LI8.chem$winter.year <- ifelse(LI8.chem$month %in% c('January','February','March'), LI8.chem$year, ifelse(LI8.chem$month %in% c('October', 'November','December'), LI8.chem$year+1, LI8.chem$year))
```

```{r}
CI1.chem$year=as.numeric(CI1.chem$year)
CI1.chem$winter.year <- ifelse(CI1.chem$month %in% c('January','February','March'), CI1.chem$year, ifelse(CI1.chem$month %in% c('October', 'November','December'), CI1.chem$year+1, CI1.chem$year))
```

```{r}
CI2.chem$year=as.numeric(CI2.chem$year)
CI2.chem$winter.year <- ifelse(CI2.chem$month %in% c('January','February','March'), CI2.chem$year, ifelse(CI2.chem$month %in% c('October', 'November','December'), CI2.chem$year+1, CI2.chem$year))
```

```{r}
CI3.chem$year=as.numeric(CI3.chem$year)
CI3.chem$winter.year <- ifelse(CI3.chem$month %in% c('January','February','March'), CI3.chem$year, ifelse(CI3.chem$month %in% c('October', 'November','December'), CI3.chem$year+1, CI3.chem$year))
```

```{r}
CI4.chem$year=as.numeric(CI4.chem$year)
CI4.chem$winter.year <- ifelse(CI4.chem$month %in% c('January','February','March'), CI4.chem$year, ifelse(CI4.chem$month %in% c('October', 'November','December'), CI4.chem$year+1, CI4.chem$year))
```

```{r}
CI5.chem$year=as.numeric(CI5.chem$year)
CI5.chem$winter.year <- ifelse(CI5.chem$month %in% c('January','February','March'), CI5.chem$year, ifelse(CI5.chem$month %in% c('October', 'November','December'), CI5.chem$year+1, CI5.chem$year))
```

```{r}
CI6.chem$year=as.numeric(CI6.chem$year)
CI6.chem$winter.year <- ifelse(CI6.chem$month %in% c('January','February','March'), CI6.chem$year, ifelse(CI6.chem$month %in% c('October', 'November','December'), CI6.chem$year+1, CI6.chem$year))
```



###############################################
# Now *aggregate data for year and season*,* using the year winter label
###############



# Aggregate (mean) data to season and years
```{r}
LI1.chem.seas=
LI1.chem %>% 
  select(-c(Site,Date, month)) %>% 
  group_by(winter.year, Season) %>% 
  summarise_all(mean, na.rm=T) %>% 
  add_column(Site=rep('LI1', nrow=LI1.chem.seas), .before="year")

```

```{r}
LI2.chem.seas=
LI2.chem %>% 
  select(-c(Site,Date, month)) %>% 
  group_by(winter.year, Season) %>% 
  summarise_all(mean, na.rm=T) %>% 
  add_column(Site='LI2', .before="year")
```

```{r}
LI3.chem.seas=
LI3.chem %>% 
  select(-c(Site,Date, month)) %>% 
  group_by(winter.year, Season) %>% 
  summarise_all(mean, na.rm=T) %>% 
  add_column(Site='LI3', .before="year")
```

```{r}
LI4.chem.seas=
LI4.chem %>% 
  select(-c(Site,Date, month)) %>% 
  group_by(winter.year, Season) %>% 
  summarise_all(mean, na.rm=T) %>% 
  add_column(Site='LI4', .before="year")
```

```{r}
LI5.chem.seas=
LI5.chem %>% 
  select(-c(Site,Date, month)) %>% 
  group_by(winter.year, Season) %>% 
  summarise_all(mean, na.rm=T) %>% 
  add_column(Site='LI5', .before="year")
```

```{r}
LI6.chem.seas=
LI6.chem %>% 
  select(-c(Site,Date, month)) %>% 
  group_by(winter.year, Season) %>% 
  summarise_all(mean, na.rm=T) %>% 
  add_column(Site='LI6', .before="year")
```

```{r}
LI7.chem.seas=
LI7.chem %>% 
  select(-c(Site,Date, month)) %>% 
  group_by(winter.year, Season) %>% 
  summarise_all(mean, na.rm=T) %>% 
  add_column(Site='LI7', .before="year")
```

```{r}
LI8.chem.seas=
LI8.chem %>% 
  select(-c(Site,Date, month)) %>% 
  group_by(winter.year, Season) %>% 
  summarise_all(mean, na.rm=T) %>% 
  add_column(Site='LI8', .before="year")
```

```{r}
CI1.chem.seas=
CI1.chem %>% 
  select(-c(Site,Date, month)) %>% 
  group_by(winter.year, Season) %>% 
  summarise_all(mean, na.rm=T) %>% 
  add_column(Site='CI1', .before="year")
```

```{r}
CI2.chem.seas=
CI2.chem %>% 
  select(-c(Site,Date, month)) %>% 
  group_by(winter.year, Season) %>% 
  summarise_all(mean, na.rm=T) %>% 
  add_column(Site='CI2', .before="year")
```

```{r}
CI3.chem.seas=
CI3.chem %>% 
  select(-c(Site,Date, month)) %>% 
  group_by(winter.year, Season) %>% 
  summarise_all(mean, na.rm=T) %>% 
  add_column(Site='CI3', .before="year")
```

```{r}
CI4.chem.seas=
CI4.chem %>% 
  select(-c(Site,Date, month)) %>% 
  group_by(winter.year, Season) %>% 
  summarise_all(mean, na.rm=T) %>% 
  add_column(Site='CI4', .before="year")
```

```{r}
CI5.chem.seas=
CI5.chem %>% 
  select(-c(Site,Date, month)) %>% 
  group_by(winter.year, Season) %>% 
  summarise_all(mean, na.rm=T) %>% 
  add_column(Site='CI5', .before="year")
```

```{r}
CI6.chem.seas=
CI6.chem %>% 
  select(-c(Site,Date, month)) %>% 
  group_by(winter.year, Season) %>% 
  summarise_all(mean, na.rm=T) %>% 
  add_column(Site='CI6', .before="year")
```

# Exploring some trends in pH
```{r}
CI1.chem.seas %>% 
  ggplot()+aes(as.numeric(year), pH)+geom_smooth(aes(col=Season))

CI2.chem.seas %>% 
  ggplot()+aes(as.numeric(year), pH)+geom_smooth(aes(col=Season))

LI1.chem.seas %>% 
  ggplot()+aes(as.numeric(year), pH)+geom_smooth(aes(col=Season))

```

# Combining *rbind* all seasonal means for chemistry across sites
```{r}
LB_chem.seas=
  rbind(LI1.chem.seas, LI2.chem.seas, LI3.chem.seas, LI4.chem.seas,LI5.chem.seas,
        LI6.chem.seas, LI7.chem.seas, LI8.chem.seas,
        CI1.chem.seas, CI2.chem.seas,CI3.chem.seas, CI4.chem.seas,CI5.chem.seas,CI6.chem.seas)
```

# LB combined sites explore pH trends
```{r warning=F}
LB_chem.seas %>% 
  ggplot()+aes(as.numeric(year), pH)+geom_smooth(aes(col=Season))+theme_bw()+
  facet_wrap(~Site)
```
# LB trends in Alakalinity *scale.free*
```{r, warning=F}
LB_chem.seas %>% 
  ggplot()+aes(as.numeric(year), Alky_pH_4.5)+geom_smooth(aes(col=Season))+theme_bw()+
  facet_wrap(~Site, scale ='free_y')
```
# LB trends in NOx
```{r, warning=F}
LB_chem.seas %>% 
  ggplot()+aes(as.numeric(year), N_Oxidised)+geom_smooth(aes(col=Season))+theme_bw()+
  facet_wrap(~Site)
```

# LB trends in Al_filtered *scale.free!*
```{r, warning=F}
LB_chem.seas %>% 
  ggplot()+aes(as.numeric(year), Al_Filtered)+geom_smooth(aes(col=Season))+theme_bw()+
  facet_wrap(~Site, scale='free_y')
```

# LB trends in Cond20C
*this variable could be omitted from PCA eventually*
```{r, warning=F}
LB_chem.seas %>% 
  ggplot()+aes(as.numeric(year), Cond20C)+geom_smooth(aes(col=Season))+
  facet_wrap(~Site)
```

# Can fill the NAs in the seasonal data with mean within each stream

## Function to *fill the NAn in df with mean of respective column*  
```{r}
NAN2mean=function(x){
  x[which(is.nan(x)==T)]=mean(x, na.rm=T)
  return(x)
}

#test
test=c(1,4,5,7,NaN,2)
NAN2mean(test)

```

# Function that uses the NAN2mean function, but first splits the df into summer and winter, then fill the NAs separately, then joins the season in a single df

```{r}
NAN2mean.seas=function(df){
  s= df %>% filter(Season=='Summer') # extract summer
  w= df %>% filter(Season=='Winter') # extract winter
  w.fill=cbind(w[,c(1,2,3,4)],as.data.frame(apply(w[,c(5:17)], 2, NAN2mean))) # use the NAN2mean function to fill the NAs with column mean (within season)
  s.fill=cbind(s[,c(1,2,3,4)],as.data.frame(apply(s[,c(5:17)], 2, NAN2mean))) # the same but for summer
  df.fill=rbind(w.fill, s.fill) # cbind the seasons
  df.fill=df.fill[order(df.fill$winter.year),] # sort them as the original df
  return(df.fill)
}
```


######## *FILLING some NAs in seasonal data with respective column and season mean* ####
# fill the seasonal chem data using the NAN2mean.seas function
```{r}
LI1.chem.seas.fill=NAN2mean.seas(LI1.chem.seas)
  
```

```{r}
LI2.chem.seas.fill=NAN2mean.seas(LI2.chem.seas)
```

```{r}
LI3.chem.seas.fill=NAN2mean.seas(LI3.chem.seas)
```

```{r}
LI4.chem.seas.fill=NAN2mean.seas(LI4.chem.seas)
```


```{r}
LI5.chem.seas.fill=NAN2mean.seas(LI5.chem.seas)
```  

```{r}
LI6.chem.seas.fill=NAN2mean.seas(LI6.chem.seas)
```

```{r}
LI7.chem.seas.fill=NAN2mean.seas(LI7.chem.seas)
```

```{r}
LI8.chem.seas.fill=NAN2mean.seas(LI8.chem.seas)
```

```{r}
CI1.chem.seas.fill=NAN2mean.seas(CI1.chem.seas)
```

```{r}
CI2.chem.seas.fill=NAN2mean.seas(CI2.chem.seas)
```

```{r}
CI3.chem.seas.fill=NAN2mean.seas(CI3.chem.seas)
```

```{r}
CI4.chem.seas.fill=NAN2mean.seas(CI4.chem.seas)
```

```{r}
CI5.chem.seas.fill=NAN2mean.seas(CI5.chem.seas)
```

```{r}
CI6.chem.seas.fill=NAN2mean.seas(CI6.chem.seas)
```

# There is still outlier in Hardness in LI1
```{r}
summary(LI1.chem.seas.fill$Hardness)
which.max(LI1.chem.seas.fill$Hardness)

LI1.chem.seas.fill[50,8] # 70 is way too much I thnk

```
# Convert this high hardness into the mean of column
```{r}
LI1.chem.seas.fill[50,8] = mean(LI1.chem.seas.fill$Hardness)
```



# Comnine all the sites using the filled df, towards the first PCA on chem data
```{r}
LB_chem.seas.fill=rbind(LI1.chem.seas.fill, LI2.chem.seas.fill, LI3.chem.seas.fill, LI4.chem.seas.fill, 
                        LI5.chem.seas.fill, LI6.chem.seas.fill, LI7.chem.seas.fill, LI8.chem.seas.fill,
                        CI1.chem.seas.fill, CI2.chem.seas.fill, CI3.chem.seas.fill, CI4.chem.seas.fill, CI5.chem.seas.fill, CI6.chem.seas.fill)
```
# Exploring again outliers in the LB total chemistry
```{r}
summary(LB_chem.seas.fill)
```

# Just get the mean for each site and season
```{r}
LB_overall.mean=
LB_chem.seas.fill %>% 
  group_by(Site, Season) %>% 
  summarise_all(mean)
```



####################################
# Carry on the *PCA on chemistry*.
###################################


```{r}
PCA.chem=princomp(LB_chem.seas.fill[,c(5:17)], cor=T, scores=T)
```

```{r}
PCA.chem$loadings
PCA.chem$scores
```

```{r}
install.packages('factoextra')
library(factoextra)
```

```{r}
fviz_pca_var(PCA.chem, repel = T, col.var="contrib",  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"))
```

```{r}
fviz_pca_ind(PCA.chem, habillage = LB_chem.seas.fill$Site, addEllipses = T, label='none')
```




# Extract the scores of PCA chemistry into a df
```{r}
PCA.chem.ax=
  cbind(LB_chem.seas.fill[,c(1,2,3,4)],
        as.data.frame(PCA.chem$scores)
       )

```
# Derive hulls for Site and Season over the two PC axes
```{r}
hull_pca.chem=
PCA.chem.ax %>% 
  group_by(Site, Season) %>% 
  slice(chull(Comp.1, Comp.2))
```

# Plot All sites with Hull - very confusing
```{r}
PCA.chem.ax %>% 
  mutate(year=as.numeric(year)) %>% 
  #filter(Season=='Winter') %>% 
  ggplot()+aes(Comp.1, Comp.2, col=Site)+geom_point(alpha=.2)+geom_polygon(data=hull_pca.chem, fill=NA)


```

# Plot the Chem PCA with sites centroids only
```{r}
PCA.chem.ax %>% 
  #filter(Season=='Summer') %>% 
  filter(Season=='Winter') %>% 
  select(c(1:6)) %>% 
  group_by(Site) %>% 
  mutate(centr.c1=mean(Comp.1), centr.c2=mean(Comp.2)) %>% 
  ggplot()+aes(Comp.1, Comp.2)+geom_text(aes(centr.c1, centr.c2, label=Site))+theme_bw()
```



# Plot PC with year trajectories for each site
```{r}
PCA.chem.ax %>% 
  mutate(year=as.numeric(year)) %>% 
  #filter(Season=='Winter') %>% 
  filter(Season=='Summer') %>% 
dplyr:: filter(Site %in% c('CI2', 'CI4','CI5', 'LI1', 'LI2', 'LI4', 'LI5', 'LI6', 'LI8')) %>%  
  ggplot()+aes(Comp.1, Comp.2, col=year)+geom_point(size=0.5)+geom_path()+theme_bw()+
  facet_wrap(~Site)+scale_color_gradient(high='darkblue', low='gold3')+ggtitle('Summer')
```

```{r}
PCA.chem.ax %>% 
  mutate(year=as.numeric(year)) %>% 
  filter(Season=='Winter') %>% 
  #filter(Season=='Summer') %>% 
dplyr:: filter(Site %in% c('CI2', 'CI4','CI5', 'LI1', 'LI2', 'LI4', 'LI5', 'LI6', 'LI8')) %>%  
  ggplot()+aes(Comp.1, Comp.2, col=year)+geom_point(size=0.5)+geom_path()+theme_bw()+
  facet_wrap(~Site)+scale_color_gradient(high='darkblue', low='gold3')+ggtitle('Winter')
```

```{r}
PCA.chem.ax %>% 
  ggplot()+aes(winter.year, Comp.1)+geom_path()+facet_wrap(~Site)
```




# Explore the years in common across streams
## derive a variable reporting the years of data available
```{r}
LI1.year=
unique(LI1.chem.seas.fill$year)

LI2.year=
unique(LI2.chem.seas.fill$year)

LI3.year=
unique(LI3.chem.seas.fill$year)

LI4.year=
  unique(LI4.chem.seas.fill$year)

LI5.year=
  unique(LI5.chem.seas.fill$year)

LI6.year=
  unique(LI6.chem.seas.fill$year)

LI7.year=
  unique(LI7.chem.seas.fill$year)

LI8.year=
  unique(LI8.chem.seas.fill$year)

CI1.year=
  unique(CI1.chem.seas.fill$year)

CI2.year=
  unique(CI2.chem.seas.fill$year)

CI3.year=
  unique(CI3.chem.seas.fill$year)

CI4.year=
  unique(CI4.chem.seas.fill$year)

CI5.year=
  unique(CI5.chem.seas.fill$year)

CI6.year=
  unique(CI6.chem.seas.fill$year)
```

```{r}
LI4.year

```


# Try to construct a dataframe to hold common PC axis scores across sites
*PC1*
```{r}
Common.PC1=data.frame(
  year=rep(c(1981:2019), each=2),
  Season=rep(c('Summer', 'Winter'), 39)
)

Common.PC1$year_season=paste(Common.PC1$year, Common.PC1$Season, sep='_')
```

# Add a **column reporting winter.year_season for each observation in PCA axes df*
Here I use the winter year to match the right season in the year of sampling...
```{r}
PCA.chem.ax$wyear_season=paste(PCA.chem.ax$winter.year, PCA.chem.ax$Season, sep="_")
```

# Now add to the common PCs the actual PC scores *PC1*  from each stream by matching site_season
Not the most elegant way...
## A
```{r}
zio=PCA.chem.ax %>% filter(Site=='LI1') # first just extract each site at a time

Common.PC1$PC1.LI1= zio$Comp.1[match(Common.PC1$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='LI2')
Common.PC1$PC1.LI2= zio$Comp.1[match(Common.PC1$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='LI3')
Common.PC1$PC1.LI3= zio$Comp.1[match(Common.PC1$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='LI4')
Common.PC1$PC1.LI4= zio$Comp.1[match(Common.PC1$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='LI5')
Common.PC1$PC1.LI5= zio$Comp.1[match(Common.PC1$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='LI6')
Common.PC1$PC1.LI6= zio$Comp.1[match(Common.PC1$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='LI7')
Common.PC1$PC1.LI7= zio$Comp.1[match(Common.PC1$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='LI8')
Common.PC1$PC1.LI8= zio$Comp.1[match(Common.PC1$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='CI1')
Common.PC1$PC1.CI1= zio$Comp.1[match(Common.PC1$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='CI2')
Common.PC1$PC1.CI2= zio$Comp.1[match(Common.PC1$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='CI3')
Common.PC1$PC1.CI3= zio$Comp.1[match(Common.PC1$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='CI4')
Common.PC1$PC1.CI4= zio$Comp.1[match(Common.PC1$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='CI5')
Common.PC1$PC1.CI5= zio$Comp.1[match(Common.PC1$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='CI6')
Common.PC1$PC1.CI6= zio$Comp.1[match(Common.PC1$year_season, zio$wyear_season)]


```


# Construct a df for *common PC2*
```{r}
Common.PC2=data.frame(
  year=rep(c(1981:2019), each=2),
  Season=rep(c('Summer', 'Winter'), 39)
)

Common.PC2$year_season=paste(Common.PC2$year, Common.PC2$Season, sep='_')
```

```{r}
zio=PCA.chem.ax %>% filter(Site=='LI1') # first just extract each site at a time

Common.PC2$PC2.LI1= zio$Comp.2[match(Common.PC2$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='LI2')
Common.PC2$PC2.LI2= zio$Comp.2[match(Common.PC2$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='LI3')
Common.PC2$PC2.LI3= zio$Comp.2[match(Common.PC2$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='LI4')
Common.PC2$PC2.LI4= zio$Comp.2[match(Common.PC2$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='LI5')
Common.PC2$PC2.LI5= zio$Comp.2[match(Common.PC2$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='LI6')
Common.PC2$PC2.LI6= zio$Comp.2[match(Common.PC2$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='LI7')
Common.PC2$PC2.LI7= zio$Comp.2[match(Common.PC2$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='LI8')
Common.PC2$PC2.LI8= zio$Comp.2[match(Common.PC2$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='CI1')
Common.PC2$PC2.CI1= zio$Comp.2[match(Common.PC2$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='CI2')
Common.PC2$PC2.CI2= zio$Comp.2[match(Common.PC2$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='CI3')
Common.PC2$PC2.CI3= zio$Comp.2[match(Common.PC2$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='CI4')
Common.PC2$PC2.CI4= zio$Comp.2[match(Common.PC2$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='CI5')
Common.PC2$PC2.CI5= zio$Comp.2[match(Common.PC2$year_season, zio$wyear_season)]

zio=PCA.chem.ax %>% filter(Site=='CI6')
Common.PC2$PC2.CI6= zio$Comp.2[match(Common.PC2$year_season, zio$wyear_season)]
```



```{r}
library(corrplot)
```


# Test for simple synchrony (correlation) between each pairs. 
*here using complete cases with 7 streams*
```{r}
Common.PC1 %>% 
  filter(Season=='Summer') %>% 
  select(-c(Season, year_season, PC1.LI2,PC1.LI3,PC1.LI7, PC1.LI8, PC1.CI1, PC1.CI3,PC1.CI6)) %>% 
  na.omit %>% 
  select(-year) %>% 
  cor() %>% 
  corrplot(method='color', type='lower', addCoef.col = "black", title = 'Summer PC1 synchrony', mar=c(0,0,3,0), number.cex = .8, tl.cex = 0.7)


```
# As above, synchrony for winter 
```{r}
Common.PC1 %>% 
  filter(Season=='Winter') %>% 
  select(-c(Season, year_season, PC1.LI2,PC1.LI3,PC1.LI7, PC1.LI8, PC1.CI1, PC1.CI3,PC1.CI6)) %>% 
  na.omit %>% 
  select(-year) %>% 
  cor() %>% 
  corrplot(method='color', type='lower', addCoef.col = "black", title = 'Winter PC1 synchrony', mar=c(0,0,3,0), number.cex = 0.8,tl.cex = 0.7)

```




# Synchrny pairwise corr
*here using pairwise.complete.obs for 9 streams*
```{r}
Common.PC1 %>% 
  filter(Season=='Summer') %>% 
  select(-c(Season, year_season, PC1.LI3,PC1.LI7, PC1.CI1, PC1.CI3, PC1.CI6)) %>% 
  #na.omit %>% 
  select(-year) %>% 
  cor(use='pairwise.complete.obs') %>% 
  corrplot(method='color', type='lower', addCoef.col = "black", title = 'Summer synchrony', mar=c(0,0,2,0), number.cex = .8)
```
# Count the missing values for each stream in the common PCs

```{r}
apply( Common.PC1,2, function(x) sum(is.na(x)))
```


########################################################
# Explore the combination of sites with minimum missin data
```{r}
Common.PC1 %>% 
  #filter(Season=='Summer') %>% 
  filter(Season=='Winter') %>% 
  select(year, Season,PC1.LI1, PC1.LI4,PC1.LI5, PC1.LI6,  PC1.CI2,PC1.CI4) %>% 
  #select(year) %>% unique()
  na.omit 
```

# Create the first *most complete set of PC1 scores for a few streams*. Will inpute missing values where reasonable
```{r}
Compl.comm.PC1=
Common.PC1 %>% 
  #filter(Season=='Summer') %>% 
  #filter(Season=='Winter') %>% 
  select(year, Season,PC1.LI1, PC1.LI4,PC1.LI5, PC1.LI6,  PC1.CI2,PC1.CI4)
```

# filling some missin values with means
*summer of 1992 for LI1 and LI4 streams* is now filled
```{r}
which(is.na(Compl.comm.PC1$PC1.LI1)) # these is a summer value

# Fill the summer NA in LI1 with the mean of summer scores
Compl.comm.PC1$PC1.LI1 [which(is.na(Compl.comm.PC1$PC1.LI1))] =
Compl.comm.PC1 %>% filter(Season=='Summer') %>% select(PC1.LI1) %>% colMeans(na.rm=T)

# Fill the summer NA in LI2 with the mean of summer scores
Compl.comm.PC1$PC1.LI4 [which(is.na(Compl.comm.PC1$PC1.LI4))] =
Compl.comm.PC1 %>% filter(Season=='Summer') %>% select(PC1.LI4) %>% colMeans(na.rm=T)

```

# *fill LI5 stream*
```{r}
#Summer
Compl.comm.PC1$PC1.LI5[ c(23,25,27,31)]# these are all summer NA for LI5

# fill these summer scores with the overal mean of summer for this site
Compl.comm.PC1$PC1.LI5[ c(23,25,27,31)]=rep( Compl.comm.PC1 %>% filter(Season=='Summer') %>% select(PC1.LI5) %>% colMeans(na.rm=T), 4)

#Winter
Compl.comm.PC1$PC1.LI5[ c(24,26,32)] # these are winter months wiht NAs
# fill
Compl.comm.PC1$PC1.LI5[ c(24,26,32)]=rep( Compl.comm.PC1 %>% filter(Season=='Winter') %>% select(PC1.LI5) %>% colMeans(na.rm=T), 3)

Compl.comm.PC1$PC1.LI5[ c(28)] # another winter nA
Compl.comm.PC1$PC1.LI5[ c(28)] = Compl.comm.PC1 %>% filter(Season=='Winter') %>% select(PC1.LI5) %>% colMeans(na.rm=T)
```


# *fill LI6 stream*
```{r}
#summer
Compl.comm.PC1$PC1.LI6[c(5,23,27,29)]# these are summer months with NAs
#fill
Compl.comm.PC1$PC1.LI6[c(5,23,27,29)]=rep( Compl.comm.PC1 %>% filter(Season=='Summer') %>% select(PC1.LI6) %>% colMeans(na.rm=T), 4)

#winter
Compl.comm.PC1$PC1.LI6[c(6,30)]

Compl.comm.PC1$PC1.LI6[c(6,30)]= rep( Compl.comm.PC1 %>% filter(Season=='Winter') %>% select(PC1.LI6) %>% colMeans(na.rm=T), 2)

Compl.comm.PC1$PC1.LI6[c(8,32)]# other winter NAs

 Compl.comm.PC1$PC1.LI6[c(8,32)]= rep( Compl.comm.PC1 %>% filter(Season=='Winter') %>% select(PC1.LI6) %>% colMeans(na.rm=T), 2)


```

# *fill CI2 stream*
```{r}
#summer
Compl.comm.PC1$PC1.CI2[c(1,3,5,23)]#these are suymmer months with NAs- the first three years are missing entirely

Compl.comm.PC1$PC1.CI2[c(1,3,5,23)]= rep( Compl.comm.PC1 %>% filter(Season=='Summer') %>% select(PC1.CI2) %>% colMeans(na.rm=T), 4)

#winter
Compl.comm.PC1$PC1.CI2[c(2,4,6)]# these are winter months with NAs
#fill
Compl.comm.PC1$PC1.CI2[c(2,4,6)] =rep( Compl.comm.PC1 %>% filter(Season=='Winter') %>% select(PC1.CI2) %>% colMeans(na.rm=T), 3)

Compl.comm.PC1$PC1.CI2[c(8)]# a winter NAs
Compl.comm.PC1$PC1.CI2[c(8)]=Compl.comm.PC1 %>% filter(Season=='Winter') %>% select(PC1.CI2) %>% colMeans(na.rm=T)

```


# *fill CI4 stream*
```{r}
#summer
Compl.comm.PC1$PC1.CI4[c(1,3,5,23)]#these are suymmer months with NAs- the first three years are missing entirely

Compl.comm.PC1$PC1.CI4[c(1,3,5,23)]= rep( Compl.comm.PC1 %>% filter(Season=='Summer') %>% select(PC1.CI4) %>% colMeans(na.rm=T), 4)

#winter
Compl.comm.PC1$PC1.CI4[c(2,4,6)]# these are winter months with NAs
#fill
Compl.comm.PC1$PC1.CI4[c(2,4,6)] =rep( Compl.comm.PC1 %>% filter(Season=='Winter') %>% select(PC1.CI4) %>% colMeans(na.rm=T), 3)


```


####### Correlation synchrony across 6 streams using PC1 scores
# The *correlation [synchrony] plot for the imputed PC1 scores* across 6 streams
```{r}
Compl.comm.PC1 %>% 
  filter(Season=='Summer') %>% 
  select(- c(year, Season)) %>% 
  cor %>% 
  corrplot(method='color', type='lower', addCoef.col = "black", title = 'Summer inp.PC1 synchrony', mar=c(0,0,2,0), number.cex = .8, tl.cex = 0.8)

```

# winter cor
```{r}
Compl.comm.PC1 %>% 
  filter(Season=='Winter') %>% 
  select(- c(year, Season)) %>% 
  cor %>% 
  corrplot(method='color', type='lower', addCoef.col = "black", title = 'Winter inp.PC1 synchrony', mar=c(0,0,2,0), number.cex = .8, tl.cex = 0.8)
  
```



# plotting simple correlation between sites based on PC1 and delta PC1
```{r}
Compl.comm.PC1 %>% filter(Season=='Winter') %>% filter(year %in% c(1985:2018)) %>% select(c(3,4,5,6,7,8)) %>% as.matrix() %>% diff() %>% 
  as.data.frame() %>% pairs(panel=panel.smooth)

Compl.comm.PC1 %>% filter(Season=='Winter') %>% filter(year %in% c(1985:2018)) %>% select(c(3,4,5,6,7,8)) %>% 
  as.data.frame() %>% pairs(panel=panel.smooth)

```



###############################

### Play with *wsyn* 

```{r}
install.packages('wsyn')
library(wsyn)
```

# create a time vector for the common PC1 scores of length = nrows(Commpcomm.PC1)
```{r}
time1= (1: dim(Compl.comm.PC1)[1])# the full time steps including winter-summer

time2= (1981: max(Compl.comm.PC1$year))# the season-only time steps

```

# test of wavelt transform on the PC1.LI1 scores
# convert the LI1 scores to a vector and perform the wavelet t function
```{r}
ts.LI1.PC1=Compl.comm.PC1 %>% filter(Season=='Summer') %>% pull(PC1.LI1)
ts.LI1.PC1=cleandat(ts.LI1.PC1, time2,clev=1)
wl.LI1.PC1=wt(ts.LI1.PC1$cdat, time2)

plotmag(wl.LI1.PC1)
```
 
 # WT on LI4 season specific
```{r}
ts.LI4.PC1=Compl.comm.PC1 %>% filter(Season=='Winter') %>% pull(PC1.LI4)
ts.LI4.PC1=cleandat(ts.LI4.PC1, time2,clev=1)
wl.LI4.PC1=wt(ts.LI4.PC1$cdat, time2)
plotmag(wl.LI4.PC1)
```
 
 
 # WT on LI5 season specific
```{r}
ts.LI5.PC1=Compl.comm.PC1 %>% filter(Season=='Winter') %>% pull(PC1.LI5)
ts.LI5.PC1=cleandat(ts.LI5.PC1, time2,clev=1)
wl.LI5.PC1=wt(ts.LI5.PC1$cdat, time2)
plotmag(wl.LI5.PC1)
```


# Convert the Compl.comm.PC1 to a df feeding the wavelet phasor 
*the whole data for both seasons*
```{r}
t_compl.comm.PC1=t(Compl.comm.PC1[,-c(1,2)])
```

# *run the wpmf* for the complete datset including both seasons
```{r}
t_compl.comm.PC1=cleandat(t_compl.comm.PC1, time1, clev=1)$cdat
phas_comm.PC1=wpmf(t_compl.comm.PC1, time1, sigmethod = 'quick')
plotmag(phas_comm.PC1)
```
 
 # Convert the Compl.comm.PC1 to a df feeding the wavelet phasor 
*for each season at a time*
```{r}
t_compl.comm.PC1.w= Compl.comm.PC1 %>% filter(Season=='Winter') %>% select(-c(year, Season)) %>% t()
t_compl.comm.PC1.s= Compl.comm.PC1 %>% filter(Season=='Summer') %>% select(-c(year, Season)) %>% t()  
```

# *run the wpmf* for winter
```{r}
t_compl.comm.PC1.w=cleandat(t_compl.comm.PC1.w, time2, clev=4)$cdat
phas_comm.PC1.w=wpmf(t_compl.comm.PC1.w, time2, sigmethod = 'quick')
plotmag(phas_comm.PC1.w, title='Wavelet phasor mean filed - Winter')
```
 
```{r}
phas_comm.PC1.w$signif
```
 
 
 
 # *run the wpmf* for summer

```{r}
t_compl.comm.PC1.s=cleandat(t_compl.comm.PC1.s, time2, clev=4)$cdat# the clean summer data
phas_comm.PC1.s=wpmf(t_compl.comm.PC1.s, time2, sigmethod = 'quick')
plotmag(phas_comm.PC1.s, title='Wavelet phasor mean filed - Summer')
```




# Plot the actual timseries of each PC1 scores.

```{r}
plot(time2, t_compl.comm.PC1.s[1,]/7+1,type='o', ylim=c(0,7), yaxt = "n", ylab='PC1 scores summer', xlab='')
axis(2, at= c(1:6),  labels=c("LI1", "LI4", "LI5", "LI6", "CI2", "CI4"))
for(stream in 2:dim(t_compl.comm.PC1.s)[1]){
  lines(time2, t_compl.comm.PC1.s[stream,]/7+stream, type='o')
}
```


```{r}
plot(time2, t_compl.comm.PC1.w[1,]/7+1,type='o', ylim=c(0,7), yaxt = "n", ylab='PC1 scores winter', xlab='')
axis(2, at= c(1:6),  labels=c("LI1", "LI4", "LI5", "LI6", "CI2", "CI4"))
for(stream in 2:dim(t_compl.comm.PC1.s)[1]){
  lines(time2, t_compl.comm.PC1.w[stream,]/7+stream, type='o')
}
```




## First test of regional coherence in chemical PC1 scores across the 6 streams with imputed PC1 scores in missing years
*the coherence is generally calculated between two sets of df (driver-response), so would not make sense to do it in the chemical PC1 scores now*




# Can now assess the synchrony matrix across the PC1 scores for the 6 sites, using time-specific synchrony windows

#*ReXWT-shortscale summer*
ReXWT Summer
```{r}
syn.mat5_s=synmat(t_compl.comm.PC1.s, times=time2, method='ReXWT', tsrange=c(4,6))
```
# Assign attributes 
```{r}
dimnames(syn.mat5_s)= list(c("PC1.LI1", "PC1.LI4", "PC1.LI5", "PC1.LI6", "PC1.CI2" ,"PC1.CI4"),
                           c("PC1.LI1", "PC1.LI4", "PC1.LI5", "PC1.LI6", "PC1.CI2" ,"PC1.CI4"))
diag(syn.mat5_s)=rep(1,6)
```

#Plot the ReXWT for summer over short timescales 4-6 years. Show relatively high synchrony
```{r}
corrplot(syn.mat5_s, method='color', type='lower', addCoef.col = "black", title = 'Summer ReXWT synchrony (4-6)', mar=c(0,0,2,0), number.cex = .8, tl.cex = 0.8)
```
#*ReXWT-longscale summer*
```{r}
syn.mat9_s=synmat(t_compl.comm.PC1.s, times=time2, method='ReXWT', tsrange=c(8,10))
dimnames(syn.mat9_s)= list(c("PC1.LI1", "PC1.LI4", "PC1.LI5", "PC1.LI6", "PC1.CI2" ,"PC1.CI4"),
                           c("PC1.LI1", "PC1.LI4", "PC1.LI5", "PC1.LI6", "PC1.CI2" ,"PC1.CI4"))
diag(syn.mat9_s)=rep(1,6)
```

#Plot the ReXWT for summer over long timescales 8-10 years. Show relatively  negative synchrony
```{r}
corrplot(syn.mat9_s, method='color', type='lower', addCoef.col = "black", title = 'Summer ReXWT synchrony (8-10)', mar=c(0,0,2,0), number.cex = .8, tl.cex = 0.8)
```


#*ReXWT-shortscale winter*
ReXWT Winter
```{r}
syn.mat5_w=synmat(t_compl.comm.PC1.w, times=time2, method='ReXWT', tsrange=c(4,6))
```
# Assign attributes 
```{r}
dimnames(syn.mat5_w)= list(c("PC1.LI1", "PC1.LI4", "PC1.LI5", "PC1.LI6", "PC1.CI2" ,"PC1.CI4"),
                           c("PC1.LI1", "PC1.LI4", "PC1.LI5", "PC1.LI6", "PC1.CI2" ,"PC1.CI4"))
diag(syn.mat5_w)=rep(1,6)
```

#Plot the ReXWT for summer over short timescales 4-6 years. Show relatively high synchrony
```{r}
corrplot(syn.mat5_w, method='color', type='lower', addCoef.col = "black", title = 'Winter ReXWT synchrony (4-6)', mar=c(0,0,2,0), number.cex = .8, tl.cex = 0.8)
```


#*ReXWT-longscale winter*
ReXWT Winter
```{r}
syn.mat9_w=synmat(t_compl.comm.PC1.w, times=time2, method='ReXWT', tsrange=c(8,10))
```
# Assign attributes 
```{r}
dimnames(syn.mat9_w)= list(c("PC1.LI1", "PC1.LI4", "PC1.LI5", "PC1.LI6", "PC1.CI2" ,"PC1.CI4"),
                           c("PC1.LI1", "PC1.LI4", "PC1.LI5", "PC1.LI6", "PC1.CI2" ,"PC1.CI4"))
diag(syn.mat9_w)=rep(1,6)
```

#Plot the ReXWT for summer over short timescales 4-6 years. Show relatively high synchrony
```{r}
corrplot(syn.mat9_w, method='color', type='lower', addCoef.col = "black", title = 'Winter ReXWT synchrony (8-10)', mar=c(0,0,2,0), number.cex = .8, tl.cex = 0.8)
```





# The geog coordinates
#*note that here the coords for the stream LI4 ,LI5 are included by hand, from the map, as ISAbelle did not provide them*
```{r}
LB.coords_ISA=
  data.frame(Site=c('CI1', 'CI2', 'CI4', 'CI5', 'GI1', 'GI2',  'LI1',  'LI2', 'LI3','LI4',  'LI5', 'LI6', 'LI7',  'LI8'),
             X=  c(276250, 276359,277108,277465,273882, 273053, 280904,281104, 281393,281510 ,282030  ,282149, 281796,280437),
             Y= c(257622, 257358,256536, 255734, 246629, 246543,252987,251650, 250793,250193 ,249739  ,249639, 249283,249069)
             )
```

# Explore the coordinates 
```{r}
plot(Y~X, LB.coords_ISA %>% filter(Site!= c('GI1', 'GI2')), asp=1) 
text(Y~X, labels=Site, cex=.7, pos=2, LB.coords_ISA%>% filter(Site!= c('GI1', 'GI2')))
```

# The coordinates of the sites with chemistry (exclude the stream GI1, GI2)
```{r}
LB.coords=LB.coords_ISA %>% filter(Site!= c('GI1', 'GI2'))
```

```{r}
#library(sp)
#coordinates(LB.coords)= ~X+Y
plot(Y~X, LB.coords, asp=1) 
text(Y~X, labels=Site, cex=.7, pos=2, LB.coords)
```
# Convert the coordinated to pairwise distances (euclidean)
```{r}
dist.sites=as_tibble(as.matrix(dist(LB.coords, diag = T, upper = T)))
names(dist.sites)=LB.coords$Site
dist.sites=cbind(LB.coords$Site, dist.sites)
names(dist.sites)[1]='Site'
```
# convert the pairwise dist to a matrix of site-pairs and distances
```{r}
dist.pairs=
dist.sites %>% gather(Site2, dist, -Site)
dist.pairs$site_pairs=paste(dist.pairs$Site, dist.pairs$Site2, sep=":")
dist.pairs
```


## Which pairs of synchrony matrices we have for PC1 scores?
# The summer and winter ReXWT for the short scale 4-6 years
```{r}
syn.mat5_s
syn.mat5_w
```
# and the simple synchrony (correlation) for the PC1 scores
```{r}
#simple synchrony summer
simple.synch.s=
Compl.comm.PC1 %>% 
  filter(Season=='Summer') %>% 
  select(- c(year, Season)) %>% 
  cor

#simple synchrony winter
simple.synch.w=
Compl.comm.PC1 %>% 
  filter(Season=='Winter') %>% 
  select(- c(year, Season)) %>% 
  cor

```

# Convert the PC1 score synchrony matrices to dataframe
```{r}
# ReXWT summer
syn.mat5_s.df=
  syn.mat5_s %>% as.data.frame() %>% mutate (Site=rownames(syn.mat5_s)) %>% 
  gather(Site2, ReXWT.5s, -Site)
syn.mat5_s.df$site.pair=paste(syn.mat5_s.df$Site,syn.mat5_s.df$Site2, sep=':' )

# ReXWT winter
syn.mat5_w.df=
  syn.mat5_w %>% as.data.frame() %>% mutate (Site=rownames(syn.mat5_w)) %>% 
  gather(Site2, ReXWT.5w, -Site)
syn.mat5_w.df$site.pair=paste(syn.mat5_w.df$Site,syn.mat5_w.df$Site2, sep=':' )

# simple corr summer
simple.synch.s.df=
  simple.synch.s %>% as.data.frame() %>% mutate(Site =rownames(simple.synch.s)) %>% 
  gather(Site2, synch.s, -Site)
simple.synch.s.df$site.pair=paste(simple.synch.s.df$Site,simple.synch.s.df$Site2, sep=':') 

# simple corr winter
simple.synch.w.df=
  simple.synch.w %>% as.data.frame() %>% mutate(Site =rownames(simple.synch.w)) %>% 
  gather(Site2, synch.w, -Site)
simple.synch.w.df$site.pair=paste(simple.synch.w.df$Site,simple.synch.w.df$Site2, sep=':') 
  
```

# Combine the synchronies df 

```{r}
synchronies.df=
  cbind(syn.mat5_s.df[,c(1,2,4)], syn.mat5_s.df[3], syn.mat5_w.df[3],simple.synch.s.df[3], simple.synch.w.df[3])

synchronies.df$site.pair2=str_remove(synchronies.df$site.pair, c('PC1.'))
synchronies.df$site.pair2=str_remove(synchronies.df$site.pair2, c('PC1.'))
```
# Add the geographic distances between streams into the synchronies df
```{r}
synchronies.df$dist=dist.pairs$dist[match(synchronies.df$site.pair2, dist.pairs$site_pairs)]
```

# Exploring distance-decay of PC1 score synchrony
#ReXWT.5s
```{r fig.width=5}
#some decay in summer
#synchronies.df %>% 
  synchronies.df[duplicated(synchronies.df$dist)==F,] %>%
  filter(dist!=0) %>% 
  ggplot()+aes(dist, ReXWT.5s)+geom_point()+geom_smooth()+theme_bw()+geom_text_repel(aes(label=site.pair2), size=2.9)+ylab('Summer synchrony (4-6 y timescale)')+xlab('Geographic distance')
```

```{r}
# no trends or opposite in winter
synchronies.df %>% 
  filter(dist!=0) %>% 
  ggplot()+aes(dist, ReXWT.5w)+geom_point()+geom_smooth()
```


```{r fig.width=5}
# no trends for simple summer snch
#synchronies.df %>% 
 synchronies.df[duplicated(synchronies.df$dist)==F,] %>%
 filter(dist!=0) %>% 
  ggplot()+aes(dist, synch.s)+geom_point()+geom_smooth()+geom_text_repel(aes(label=site.pair2), size=2.9)+
  theme_bw()+ylab('Summer synchrony (as correlation)')+xlab('Geographic distance')
```

```{r}
# no trends for simple winter snch
 synchronies.df[duplicated(synchronies.df$dist)==F,] %>%
 filter(dist!=0) %>% 
  ggplot()+aes(dist, synch.w)+geom_point()+geom_smooth()+geom_text_repel(aes(label=site.pair2), size=2.9)+
  theme_bw()+ylab('Winter synchrony (as correlation)')+xlab('Geographic distance')
```

# Create a distance matrix reflecting the distances among streams based on the average values of their chemical variables.
```{r}
# this is the overall mean, within seasons, of the different variables
LB_overall.mean
```

# *LB_chem.dist*
# Create a distance matrix for the overall water chemistry based on mean (over time) of each chemical variable
```{r}
LB_chem.dist=
LB_overall.mean %>% 
  as.data.frame() %>% 
  #filter(Season=='Summer') %>% 
  select(-c(Season, winter.year, year))  %>% 
  `rownames<-`(.[,1]) %>% ### add the rownames taking them from the Site column - better with distance matrix
  select(-Site) %>%   dist(diag=T, upper=T)
```

# LB_chem.dist to data frame
```{r}
LB_chem.dist.df=
LB_chem.dist %>% as.matrix() %>% 
  as.data.frame() %>% mutate(Site=attr(LB_chem.dist, 'Labels')) %>% 
  gather(Site2, chem.dist, -Site) %>% 
  mutate(site.pair=paste(Site,Site2, sep=':'))
```

# Add the chemistry distance to the synchronies dataframe
```{r}
synchronies.df$chem.dist=LB_chem.dist.df$chem.dist[match(synchronies.df$site.pair2, LB_chem.dist.df$site.pair)]
```

# No trend in synchrony vs chemical distance.
```{r fig.width=5}
#synchronies.df %>% 
  synchronies.df[duplicated(synchronies.df$dist)==F,] %>%
  filter(chem.dist!=0) %>% 
  ggplot()+aes(chem.dist, ReXWT.5s)+geom_point(size=0.5)+geom_text_repel(aes(label=site.pair2), size=2.9)+
  geom_smooth()+theme_bw()+ylab('Summer synchrony (4-6 y timescale)')+xlab('Chemical distance')
```

# Plot relation between overall chemical distance and geogr dist. positive relation.
```{r fig.width=5}
#synchronies.df %>% 
  synchronies.df[duplicated(synchronies.df$dist)==F,] %>% 
  filter(chem.dist!=0) %>% 
  ggplot()+aes(chem.dist, dist)+geom_point(size=0.5)+geom_text_repel(aes(label=site.pair2), size=2.9)+geom_smooth(method='lm')+theme_bw()+ylab('Geographic distance')+xlab('Chemical distance')
```

## First test of clustering based on different synchrony estimates

```{r}
t_compl.comm.PC1.s # this is the df with 6 streams [summer], already cleaned and used for the ReXWT above
```

# try the clustering - *important. Coordinates of sites must be given in the same order as sites in timeseries*
# create coordinates for the 6 streams that were included in the complete PC1 scores timeseries analysis
```{r}
coords6sites=LB.coords[c(5,8,9,10,2,4),]
```

# *Cluster based on ReXWT 4-6 timescale*
#summer
```{r}
cl.5s=wsyn::clust(dat=t_compl.comm.PC1.s, times=time2, coords=coords6sites,
           method="ReXWT",tsrange=c(4,6))

cl.5s$clusters
cl.5s$adj
```

# winter
```{r}
cl.5w=wsyn::clust(dat=t_compl.comm.PC1.w, times=time2, coords=coords6sites,
           method="ReXWT",tsrange=c(4,6))

cl.5w$clusters
cl.5w$adj
```


# *Clusters based on simple correlation synchorny*
#summer
```{r}
cl.synch.s=wsyn::clust(dat=t_compl.comm.PC1.s, times=time2, coords=coords6sites,
           method="pearson")
```
#winter
```{r}
cl.synch.w=wsyn::clust(dat=t_compl.comm.PC1.w, times=time2, coords=coords6sites,
           method="pearson")
```


```{r fig.width=6}
plot(Y~X, coords6sites, asp=1) 
text(Y~X, labels=Site, cex=.7, pos=2, coords6sites)
```

# Plot modularity for summer ReXWT 5, using default
```{r fig.width=6}
#plot()
plotmap(cl.5s)
```
# Add the weight of modules and their identity in the coords6sites
```{r}
coords6sites$mod.ReXWT5s=cl.5s$clusters[[2]] # add module ID based on type of synchrony (here ReXWT summer)
coords6sites$w.ReXWT5s=cl.5s$modres[[2]]$nodeQ # add node weights
coords6sites$mod.ReXWT5s=as.factor(coords6sites$mod.ReXWT5s)

coords6sites$mod.ReXWT5w=cl.5w$clusters[[2]] # add module ID based on winter ReXWT
coords6sites$w.ReXWT5w=cl.5w$modres[[2]]$nodeQ
coords6sites$mod.ReXWT5w=as.factor(coords6sites$mod.ReXWT5w)

coords6sites$mod.synch.s=cl.synch.s$clusters[[2]] # add modules based in simple synchrony summer (corr)
coords6sites$w.synch.s=cl.synch.s$modres[[2]]$nodeQ
coords6sites$mod.synch.s=as.factor(coords6sites$mod.synch.s)

coords6sites$mod.synch.w=cl.synch.w$clusters[[2]] # add modules based in simple synchrony winter (corr)
coords6sites$w.synch.w=cl.synch.w$modres[[2]]$nodeQ
coords6sites$mod.synch.w=as.factor(coords6sites$mod.synch.w)
```
# Plot modularity in ggplot including streams not used in the chemical PC1 scores synchrony
```{r}
module5.s=
coords6sites %>% 
     ggplot()+aes(X, Y)+geom_point(aes(size=w.ReXWT5s, col=mod.ReXWT5s))+theme_bw()+coord_fixed()+
   ggtitle('Modules summer synchrony (4-6 y timescale)')+theme(title=element_text(size=8), legend.position = 'none')+
   geom_text_repel(data=LB.coords, aes(x=X, y=Y, label=Site), size=2.7)+geom_point(data=LB.coords, aes(x=X, y=Y), col='grey50', size=0.7, shape=3)

# or alternative take, ignoring specific site weight in the modules
module5.s=
 coords6sites %>% 
     ggplot()+aes(X, Y)+geom_point(aes(col=mod.ReXWT5s), size=4)+theme_bw()+coord_fixed()+
   ggtitle('Modules summer synchrony (4-6 y timescale)')+theme(title=element_text(size=8), legend.position = 'none')+
   geom_text_repel(data=LB.coords, aes(x=X, y=Y, label=Site), size=2.7)+geom_point(data=LB.coords, aes(x=X, y=Y), col='grey50', size=0.7, shape=3)


```

```{r}
module5.w=
coords6sites %>% 
     ggplot()+aes(X, Y)+geom_point(aes(size=w.ReXWT5w, col=mod.ReXWT5w))+theme_bw()+coord_fixed()+
   ggtitle('Modules winter synchrony (4-6 y timescale)')+theme(title=element_text(size=8), legend.position = 'none')+
   geom_text_repel(data=LB.coords, aes(x=X, y=Y, label=Site), size=2.7)+geom_point(data=LB.coords, aes(x=X, y=Y), col='grey50', size=0.7, shape=3)

module5.w= # alternative take, ignoring site weight in the module
coords6sites %>% 
     ggplot()+aes(X, Y)+geom_point(aes(col=mod.ReXWT5w), size=5)+theme_bw()+coord_fixed()+
   ggtitle('Modules winter synchrony (4-6 y timescale)')+theme(title=element_text(size=8), legend.position = 'none')+
   geom_text_repel(data=LB.coords, aes(x=X, y=Y, label=Site), size=2.7)+geom_point(data=LB.coords, aes(x=X, y=Y), col='grey50', size=0.7, shape=3)

```



```{r}
library(patchwork)
```

# Plot he summer and wonter module 5 (4-6 timescale)
```{r}
module5.s + module5.w + plot_layout(guides = 'collect')
```

# Plot the modules as simple synchrony as correlation
```{r}

temp1=
coords6sites %>% 
     ggplot()+aes(X, Y)+geom_point(aes(col=mod.synch.s), size=4)+theme_bw()+coord_fixed()+
   ggtitle('Modules summer synchrony (cor)')+theme(title=element_text(size=8), legend.position = 'none')+
   geom_text_repel(data=LB.coords, aes(x=X, y=Y, label=Site), size=2.7)+geom_point(data=LB.coords, aes(x=X, y=Y), col='grey50', size=0.7, shape=3)


temp2=
coords6sites %>% 
     ggplot()+aes(X, Y)+geom_point(aes(col=mod.synch.w), size=4)+theme_bw()+coord_fixed()+
   ggtitle('Modules winter synchrony (cor)')+theme(title=element_text(size=8), legend.position = 'none')+
   geom_text_repel(data=LB.coords, aes(x=X, y=Y, label=Site), size=2.7)+geom_point(data=LB.coords, aes(x=X, y=Y), col='grey50', size=0.7, shape=3)


temp1+temp2


```


# Import NAO montly data
```{r}
library(readxl)
NAOy <- read_excel("NAOdata.xlsx", sheet = "MonthlyNAO")
names(NAOy)[1]='Year'
```
# NAO to long format; Filter years
```{r}
NAOm=
NAOy %>% 
  filter(Year>1980) %>% 
  pivot_longer(-Year, names_to = 'month')

NAOm$year_month=paste(NAOm$Year, NAOm$month, sep='_')

NAOm=
  NAOm %>% 
  filter(Year<2020)

```

# Simple plot of NAO
```{r}
NAOm %>% 
  ggplot()+aes(year_month, value, group=1)+geom_path()
```

# Work on NAO monthly data for wavelet modeling
```{r}
NAOy$times=rownames(NAOy)
times.NAOy=NAOy %>% pull(times)
times.NAOy=as.numeric(times.NAOy)
```

```{r}
ts.NAOy=NAOy %>% pull(value)
ts.NAOy=cleandat(ts.NAOy, times.NAOy, clev=1)
wl.NAOy=wt(ts.NAOy$cdat, times.NAOy)

plotmag(wl.NAOy)
```

# Work on NAO seasonal (keep the winter year as with chemical data)
# Add tge winter year
```{r}
NAOm$winter.year= ifelse(NAOm$month %in% c('Jan','Feb','Mar'), NAOm$Year, ifelse(NAOm$month %in% c('Oct', 'Nov','Dec'), NAOm$Year+1, NAOm$Year))
```
# Add season to NAO
```{r}
NAOm$Season=ifelse(NAOm$month %in% c('Oct','Nov','Dec', 'Jan', 'Feb', 'Mar'), 'Winter', 'Summer')
```

# Add the seasonal mean to NAOm
```{r}
NAOm=
  NAOm %>% group_by(winter.year, Season) %>% 
  mutate(seas.mean=mean(value))
```




# The seasonal NAO, winter and summer
*Bradley & Ormerdo take winter NAO as Dec-March (I also unclude oct-nov previous year)
```{r}
NAOseason=
  NAOm%>% 
  select(winter.year, Season, value) %>% 
  group_by(winter.year, Season) %>%  summarise(mean.nao=mean(value))

```

```{r fig.width=8.5, fig.height=4}
NAOseason %>% 
  mutate(phase=ifelse(mean.nao >0, 'pos', 'neg' )) %>% 
  #filter(Season=='Winter') %>% 
  ggplot()+aes(winter.year, mean.nao)+geom_point(aes(col=phase))+
  geom_path()+facet_wrap(~Season)+theme_bw()+xlab(NULL)+geom_hline(yintercept = 0, col='grey20')+scale_color_manual(values=c('steelblue','darkred' ))+
   scale_x_continuous(breaks=seq(1981,2020, by=2))+theme(axis.text.x = element_text(angle = 45, hjust = 1))




```

```{r}
NAOseason %>% 
   mutate(phase=ifelse(mean.nao >0, 'pos', 'neg' )) %>% 
  filter(Season=='Winter') %>% 
  ggplot()+aes(winter.year, mean.nao)+geom_point(aes(col=phase))+ geom_path()+facet_wrap(~Season)+theme_bw()+xlab(NULL)+geom_hline(yintercept = 0, col='grey20')+
   scale_x_continuous(breaks=seq(1981,2020, by=2))+theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = 'none')+scale_color_manual(values=c('steelblue','red' ))+ylab('North Atlantic Oscillation (NAO')
```


# Extract timeseries for winter and summer NAO and fix for wavelet modelling
```{r}
ts.NAOw= NAOseason %>% filter(Season=='Winter') %>% pull(mean.nao)
timesNAOw= NAOseason %>% filter(Season=='Winter') %>% pull(winter.year) %>% as.numeric()

ts.NAOs= NAOseason %>% filter(Season=='Summer') %>% pull(mean.nao)
timesNAOs= NAOseason %>% filter(Season=='Summer') %>% pull(winter.year) %>% as.numeric()

#clean data for wavelet
ts.NAOw=cleandat(ts.NAOw, timesNAOw, clev=1)
ts.NAOs=cleandat(ts.NAOs, timesNAOs, clev=1)
```



#Wavelet NAO seasonal- WINTER
```{r}
wt.NAOw=wt(ts.NAOw$cdat, timesNAOw)
plotmag(wt.NAOw, title='Winter NAO')
```


#Wavelet NAO seasonal- SUMMER
```{r}
wt.NAOs=wt(ts.NAOs$cdat, timesNAOs)
plotmag(wt.NAOs)

```



```{r}
NAOseason %>% filter(Season=='Winter')
```
# Get the *smoothed NOA winter (three winters preceding)*
```{r}
smoothNAOw=
cbind.data.frame(winter.year=NAOseason %>% filter(Season=='Winter') %>% filter(winter.year %in% c(1983:2020)) %>%   pull(winter.year),
sNAO=rollmean(NAOseason %>% filter(Season=='Winter') %>% pull(mean.nao), k=3, align = 'left'))

```



```{r}
smoothNAOw %>% 
  ggplot()+aes(winter.year,sNAO)+geom_path()
```



# Plot of coherence btw wNAO and chemistry PC1
```{r}
plotmag(
coh(as.matrix(t_compl.comm.PC1.w_85_17[-3,]), as.matrix(t_NAOw_86.18.exp[match(chem.sitesID.bio,rownames(t_NAOw_86.18.exp)) ,]), 
                     time2[c(6:38)],  norm='powall', sigmethod = 'fast', nrand = 10000)
)


```




#*TO DO*

-Import the LI1 flow data from Fiona to examine and match with NAO and maybe chemistry.*done*
-Import the Duress flow data (only to 2012) for LI6 *still need to be done (as of 1 oct 2021)*


# Import LI1 flow data from Fiona
```{r}
LI1_flow <- read_csv("Rain_flow_LB_Fiona/LI1BrianneFlume15minFlow.csv")
str(LI1_flow)
```

# add details to LI1 flow data
```{r}
LI1_flow$Day=
as.Date(LI1_flow$Day, format="%d/%m/%Y")

LI1_flow$month=
month(LI1_flow$Day)

LI1_flow$Year=
format(LI1_flow$Day, format='%Y')

```

#montly LI1 flow
```{r}
LI1_flow.m=
  LI1_flow %>% group_by(Year, month) %>% summarise(m.mean=mean(Runoff, na.rm=T))

LI1_flow.m$year_month=paste(LI1_flow.m$Year, LI1_flow.m$month, sep='_') 
LI1_flow.m$time=rownames(LI1_flow.m)

summary(LI1_flow.m)

LI1_flow.m %>% 
  ggplot()+aes(time, m.mean, group=1)+geom_line()+geom_smooth()

```

# the seasonal flow for LI1
*add winter year*
```{r}
LI1_flow.m$Year=as.numeric(LI1_flow.m$Year)

LI1_flow.m$winter.year=ifelse(LI1_flow.m$month %in% c(10,11,12), LI1_flow.m$Year+1, LI1_flow.m$Year)# add winter year
LI1_flow.m$season=ifelse(LI1_flow.m$month %in% c(10,11,12,1,2,3), 'Winter', 'Summer')# add season

```
# Derive seasonal flow mean for LI1
```{r}
LI1.flow.seas=LI1_flow.m %>% group_by(season, winter.year) %>% summarise(m.season=mean(m.mean, na.rm=T))
```

# Extract winter wavelet transform - only from 1996
```{r}
ts.LI1.flow.w=LI1.flow.seas %>% filter(season=='Winter') %>% pull(m.season)
times.LI1.flow.w=LI1.flow.seas %>% filter(season=='Winter') %>% pull(winter.year) %>% as.numeric()

wt.LI1.flow.w=
  wt(cleandat(ts.LI1.flow.w, times.LI1.flow.w, clev=1)$cdat, times.LI1.flow.w )

plotmag(wt.LI1.flow.w, title='LI1 winter runoff')
```

```{r fig.width=7, fig.height=3}
plot(ts.LI1.flow.w~times.LI1.flow.w, type='l', ylab='LI1 winter runoff', xlab='')
```
################
# Should import the Plynlimon flow data (north of LB) to check for signals as well


###########
# Test import and open *flow data from Katie*
```{r}
LB_coords_flow_max <- readRDS("~/Documents/LB_synchrony/Flow_Katie/LB_coords_flow_max.rds")
```


```{r}
LB_coords_flow_max$Site

LB_coords_flow_max$X
LB_coords_flow_max[,c(1,2,3,4,c(26:60))]

```
# extract max and min flow (and mean eventually) for the 1981-2015
```{r}
katie_fmax=as.data.frame(
LB_coords_flow_max[,c(1,c(26:60))])

rownames(katie_fmax)=katie_fmax$Site # assign the rownames as sites
str(katie_fmax)
katie_fmax$coords.x1=NULL # for some reasons rthe coords are kepts, and will remove them
katie_fmax$coords.x2=NULL
```
# transform the katie flow max to df for plotting etc
```{r}
katie_fmax=
  as.data.frame(
t(katie_fmax[,-1])) %>% 
  mutate(year= seq(1981, 2015,1))
```
# Plot flow max katie for each site
```{r}
katie_fmax %>% 
  pivot_longer(cols=c(1:14), names_to = 'Site', values_to = 'Max_flow') %>% 
  ggplot()+aes(year,Max_flow)+geom_path()+facet_wrap(~Site, scale='free')
```

# applying phasor mean field to Katie flow data we see complete correlation
*Katie flow data are all synch across the grids of LB*
```{r}
katie_fmax.cl=
cleandat(t(katie_fmax[,-15]), katie_fmax$year, clev = 4)$cdat

phas_katie_fmax=wpmf(katie_fmax.cl, katie_fmax$year, sigmethod = 'quick')
plotmag(phas_katie_fmax, title='Wavelet phason mf - Katie flow max')
```


# Running the wavelet for just the LI1 stream flow data (katie) we see a familiar signal at 6-8 timescale
```{r}
wt.katie_fmax_LI1=wt(
  cleandat(t(katie_fmax$LI1),katie_fmax$year, clev = 4)$cdat, katie_fmax$year)

plotmag(wt.katie_fmax_LI1, title='WT katie fmax LI1')
```

## Import the rain data from Fiona (shared folder)
```{r}
library(readr)
LB_rain<- read_csv("Rain_flow_LB_Fiona/LB_monthly_rain_stats.csv")
LB_rain[,1]=NULL

```
# subset rain years and stream matchin LB10 bio data
```{r}
LB10_rain=
LB_rain %>% filter(Site %in% codeID) %>% filter(Ante %in% yearID)
```

# derive the yearly means for rain data (including summer and winter)
```{r}
LB10_rain_ymeans=
LB10_rain %>% 
  group_by(Site, Ante) %>% 
  summarise(m.sum=mean(sum.r), m.mean=mean(mean.r), m.wet=mean(wet_freq.r), m.dry=mean(dry_freq.r))
```


# Trends in rain stats overall
```{r}
LB10_rain_ymeans %>% 
  ggplot()+aes(Ante, m.mean)+geom_smooth()+facet_wrap(~Site)+geom_path()

LB10_rain_ymeans %>% 
  ggplot()+aes(Ante, m.dry)+geom_smooth()+facet_wrap(~Site)

```


# derive the yearly means for rain data (preceding winter only)
# and add the NAOw values
```{r}
LB10_rain_ymeans.w=
LB10_rain %>% 
  filter(Season=='Winter') %>% 
  group_by(Site, Ante) %>% 
  summarise(m.sum=mean(sum.r), m.mean=mean(mean.r), m.wet=mean(wet_freq.r), m.dry=mean(dry_freq.r))


LB10_rain_ymeans.w$NAOw=
  NAOseason[NAOseason$Season=='Winter',]$mean.nao[match(LB10_rain_ymeans.w$Ante,  NAOseason[NAOseason$Season=='Winter',]$winter.year)]


```

# Plot winter rain stats trends including relation with NAOw
*some increasing trends in n of wet days over time*
*positive NAO has more wet days, but not overall higher amount of rain*
```{r}
LB10_rain_ymeans.w %>% 
  ggplot()+aes(Ante, m.mean)+geom_smooth()+facet_wrap(~Site)+geom_path()+ylab('Mean winter rain')+xlab(NULL)

LB10_rain_ymeans.w %>% 
  ggplot()+aes(Ante, m.wet)+geom_smooth()+facet_wrap(~Site)+geom_path()+ylab('Mean winter # wet days')+xlab(NULL)


LB10_rain_ymeans.w %>% 
  ggplot()+aes(NAOw, m.wet)+geom_smooth(method='lm')+geom_jitter(aes(col=Site), width=0.2)+ylab('Monthly # wet days')+xlab("Winter NAO")+geom_vline(xintercept = 0, col='grey70')

LB10_rain_ymeans.w %>% 
  ggplot()+aes(NAOw, m.mean)+geom_smooth(method='lm')+geom_jitter(aes(col=Site), width=0.2)+ylab('Monthly rain')+xlab("Winter NAO")+geom_vline(xintercept = 0, col='grey70')
                                                                  
                                                                  
                                                                  
                                                        



```
# Wavelet of monthly mean rain
#The phasor does not make sense as there are same rain series for many streams
```{r}
plotmag(
    wpmf(
cleandat(
LB10_rain_ymeans.w %>% 
  as.data.frame() %>% 
  select(c(Site, Ante, m.mean)) %>% 
  pivot_wider(names_from = Ante, values_from = m.mean) %>% select(-'Site') %>% as.matrix(),
  times=time.lb10, clev=4)$cdat, times=time.lb10, sigmethod = 'quick'), title='Wpmf mean.monthly')

plotmag(
wt(
cleandat(
LB10_rain_ymeans.w %>% 
  as.data.frame() %>% 
  select(c(Site, Ante, m.mean)) %>% 
  pivot_wider(names_from = Ante, values_from = m.mean) %>% filter(Site=='LI8') %>% select(-'Site') %>% as.matrix(),
times=time.lb10, clev=4)$cdat, time.lb10), title='WT monthly rain LI8'
)


plotmag(
wt(
cleandat(
LB10_rain_ymeans.w %>% 
  as.data.frame() %>% 
  select(c(Site, Ante, m.wet)) %>% 
  pivot_wider(names_from = Ante, values_from = m.wet) %>% filter(Site=='LI8') %>% select(-'Site') %>% as.matrix(),
times=time.lb10, clev=4)$cdat, time.lb10), title='WT monthly wetdays LI8'
)


```


# overall coherence between wNAO and wRain
#*limited coherence between NAO and actual mean rain in winter months*
```{r}

coh_wNAO_wRain.mean=
coh(
as.matrix(t_NAOw_85.18.exp),
cleandat(
LB10_rain_ymeans.w %>% 
  as.data.frame() %>% 
  select(c(Site, Ante, m.mean)) %>% 
  pivot_wider(names_from = Ante, values_from = m.mean) %>% select(-'Site') %>% as.matrix(),
  times=time.lb10, clev=4)$cdat,
 timesNAOw[5:38],  norm='powall', sigmethod = 'fast', nrand = 10000)

plotmag(coh_wNAO_wRain.mean)
```

```{r}
coh_wNAO_wWetdays=
coh(
as.matrix(t_NAOw_85.18.exp),
cleandat(
LB10_rain_ymeans.w %>% 
  as.data.frame() %>% 
  select(c(Site, Ante, m.wet)) %>% 
  pivot_wider(names_from = Ante, values_from = m.wet) %>% select(-'Site') %>% as.matrix(),
  times=time.lb10, clev=4)$cdat,
 timesNAOw[5:38],  norm='powall', sigmethod = 'fast', nrand = 10000)

plotmag(coh_wNAO_wWetdays)
```



# The overall (across lb10) mean winter rain series
```{r}
lb10_mean_winter.rain=
LB10_rain_ymeans.w %>% 
  group_by(Ante) %>% 
  summarise(lb10.mean.w.r=mean(m.mean), lb10.mean.wetday=mean(m.wet))
```

# No strong effect of winter rain on year-to-year BC (as with wNAO)
```{r}
cbind(t(TBI.bc), time.delta, lb10_w.rain=  lb10_mean_winter.rain %>% filter(Ante %in% c(1986:2018)) %>% pull(lb10.mean.w.r)) %>% 
  as.data.frame() %>% 
  pivot_longer(cols=c(1:10)) %>% 
ggplot()+aes(lb10_w.rain, value)+geom_point(aes(col=time.delta))+scale_color_gradient(high='darkblue', low='gold3')+
  geom_smooth(method='lm')+facet_wrap(~name)+ylab('Year-to-year Bray-Curtis')


cbind(t(TBI.bc), time.delta, lb10_wetday=  lb10_mean_winter.rain %>% filter(Ante %in% c(1986:2018)) %>% pull(lb10.mean.wetday)) %>% 
  as.data.frame() %>% 
  pivot_longer(cols=c(1:10)) %>% 
ggplot()+aes(lb10_wetday, value)+geom_point(aes(col=time.delta))+scale_color_gradient(high='darkblue', low='gold3')+
  geom_smooth(method='lm')+facet_wrap(~name)+ylab('Year-to-year Bray-Curtis')



```

# Import he air T data (from Fiona shared folder)
```{r}
Tmonthly=
  read_csv("Rain_flow_LB_Fiona/HadUK_monthly_tas_1980to2019.csv")
```
# get the yearly mean winter T
```{r}
Tyearly=
Tmonthly %>% 
  filter(Season=='Winter') %>% 
  filter(Site %in% codeID) %>% filter(Ante %in% yearID) %>% 
  group_by(Ante, Site) %>% 
  summarise(mean.w.T=mean(value))
```

#Check trends in yearly winter T for the LB10 sites
*clearly rsing trends, especially up to 2000
```{r}
Tyearly %>% 
  ggplot()+aes(Ante, mean.w.T, group=1)+geom_path()+facet_wrap(~Site)+geom_smooth()+xlab(NULL)+ylab('Mean winter air T')
```

# No particular strong timescale of variation in winter T based on wavelt transform
```{r}
plotmag(
wt(
cleandat(
Tyearly %>% 
  as.data.frame() %>% 
  select(c(Site, Ante, mean.w.T)) %>% 
  pivot_wider(names_from = Ante, values_from = mean.w.T) %>% filter(Site=='LI8') %>% select(-'Site') %>% as.matrix(),
times=time.lb10, clev=4)$cdat, time.lb10), title='WT yearly w_T LI8'
)
```

```{r}
Tyearly$NAOw=
  NAOseason[NAOseason$Season=='Winter',]$mean.nao[match(Tyearly$Ante,  NAOseason[NAOseason$Season=='Winter',]$winter.year)]
```
# positive NAO match warmer T, as expected
```{r}
Tyearly %>% 
  ggplot()+aes(NAOw, mean.w.T)+geom_jitter(aes(col=Site), width=0.2)+geom_smooth(method='lm')+ylab('Mean winter air T')+xlab('Winter NAO')+geom_vline(xintercept = 0, col='grey70')
```



# Calculate moving window of PC1 synchrony

# first derive the raw values (not cleandat) of PC1 winter, and put them in ts (site x years)
```{r}
Compl.comm.PC1.raw.ts=
Compl.comm.PC1 %>% filter(Season=='Winter') %>% filter(year %in% c(1985:2018)) %>% select(c(3,4,5,6,7,8)) %>% 
  t()

# add year as colname
colnames(Compl.comm.PC1.raw.ts)=Compl.comm.PC1 %>% filter(Season=='Winter') %>% filter(year %in% c(1985:2018)) %>% pull(1)

```

# then run the mw to get synchrony for 6 years span (as done for richness, abund)

```{r}
PC1.w.synch_mw=as.data.frame(matrix(nrow=length(time.window5), ncol=1))


rownames(PC1.w.synch_mw)=time.window5
colnames(PC1.w.synch_mw)='PC1_winter.synch.mw'



# the richness synch as simple cor
for(y in 1: length(time.window5)){
 PC1.w.synch_mw[y,]= mean(
   cor(
     t(Compl.comm.PC1.raw.ts[,c(y:(y+5))]), method='spearman'
     )
   )
}
```

# then add the mwNAOw
```{r}
PC1.w.synch_mw$wNAOwindow=wNAO_window$NAOwindow[match(rownames(PC1.w.synch_mw), wNAO_window$time.window5)]
```
# Plot mw synch for PC1 winter vs NAOmw (not great synch effect of NAO on PC1 chemistry)
```{r}
PC1.w.synch_mw %>% 
  ggplot()+aes(wNAOwindow, PC1_winter.synch.mw, label=row.names(abund.synch_mw))+geom_point(size=2)+geom_text_repel(size=2.5)+
  geom_smooth( col='grey50', alpha=.3, method='lm')+ylab('PC1 winter - synchrony mw')+ xlab('Winter NAO mw')
```

# no evidence that higher NAOw values are associated with specific PC1 winter values across streams
```{r}
Compl.comm.PC1 %>% filter(Season=='Winter') %>% filter(year %in% c(1985:2018)) %>% select(c(1,3,4,5,6,7,8)) %>% 
  mutate(wNAO=NAOseason %>% filter(Season=='Winter') %>% filter(winter.year %in% c(1985:2018)) %>% pull(mean.nao)) %>% 
  pivot_longer(cols = c(2:7), values_to = 'PC1w') %>% 
  ggplot()+aes(wNAO, PC1w)+geom_point(aes(col=name))+geom_smooth()+geom_smooth(aes(col=name), se=F)


```

# function for CV
```{r}
cv.f=function(x){
  sd(x)/mean(x)
}

cv.f(c(2,4,3,6,7))

cv.f(c(-2,-40,-3,6,7))

```

# Derive CV of PC1 winter for each moving window
#*there is the problem of negative values here*
```{r}
PC1w.CV.mw=as.data.frame(matrix(nrow=length(time.window5), ncol=6))


rownames(PC1w.CV.mw)=time.window5
colnames(PC1w.CV.mw)=c('PC1.LI1','PC1.LI4','PC1.LI5', 'PC1.LI6','PC1.CI2','PC1.CI4')


for(y in 1: length(time.window5)){
  PC1w.CV.mw[y,]=apply(Compl.comm.PC1.raw.ts[,c(y:(y+5))], 1,cv.f)
}

```
```{r}
PC1w.CV.mw$wNAOmw=wNAO_window$NAOwindow[match(rownames(PC1w.CV.mw), wNAO_window$time.window5)]
```
# Plot of CV in PCwinter, maybe not relevant due to issues with CV with negatives
```{r}
PC1w.CV.mw %>% 
  pivot_longer(cols=c(1:6)) %>% 
  ggplot()+aes(wNAOmw, value)+geom_point()+geom_smooth(method='lm')+facet_wrap(~name, scale='free')
```


####################################
# Test script to import gridded climate CHESS data for 1985-2017 
*only one year (x12 files) tried so far, as of 10th.june*

```{r}
install.packages('ncdf4')
library(ncdf4)
```

```{r}
chessfiles=list.files('ClimData/', pattern='*.nc') # list of files nc downloaded

process_nc <- function(files){
    # iterate through the nc
    # # open a conneciton to the ith nc file
        #nc_tmp <- nc_open(files[i])
       testnc=nc_open(paste0("/Users/stefano/Documents/LB_synchrony/ClimData/", chessfiles[i])) # download it
       precip <- ncvar_get(testnc, "precip")# extract the data
       x_precip=ncvar_get(testnc, 'x')
       y_precip=ncvar_get(testnc, 'y')
       nc_time=ncvar_get(testnc, 'time')
       nc_time2=as.Date(nc_time, origin='1961-01-01')
       dimnames(precip)=list(lon=x_precip, lat=y_precip, time=nc_time2)
       
       precip.lb=
       precip[dimnames(precip)$lon >=275000 & dimnames(precip)$lon <= 283000 , 
       dimnames(precip)$lat<=259000 & dimnames(precip)$lat>=248000,]
       
       precip.lns=
         apply(precip.lb, c(1,2), sum, na.rm=T)
       
       return(precip.lns)
       
    }

  

process_nc(chessfiles[[2]]) # test function



  
```

# run the function over each nc file to collect the subset grids 
```{r}
nclist=list()
for (i in 1:length(chessfiles)){
  nclist[[i]] = process_nc(chessfiles[i])
}
```

```{r}
nclist[[1]]
```



